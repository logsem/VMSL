\documentclass{book}

\usepackage[margin=2cm,landscape,a3paper]{geometry}% http://ctan.org/pkg/geometry
\usepackage{iris}
\usepackage{bussproofs}
\usepackage{float}
\usepackage{multicol,multirow}
\usepackage{amsmath}
\usepackage{mathpartir}
\usepackage{mathtools}
\usepackage{hyperref}
\usepackage{todonotes}
\usepackage{graphicx}
\usepackage{kpfonts}
\usepackage{array}

\newcommand*{\VMTOK}[1]{%
    \lozenge^{#1}
}
\newcommand*{\REG}[1]{
    \mathtt{#1}
}
\newcommand*{\vdashv}{\dashv \vdash}
\newcommand*{\defined}{\triangleq}
\newcommand*{\mapsText}[1]{\xrightarrow{#1}}
\newcommand*{\maps}{\rightarrow}
\newcommand*{\derived}{::=}
\newcommand*{\PID}{\text{PID}}
\newcommand*{\AS}{\text{AccessState}}
\newcommand*{\OS}{\text{OwnershipState}}
\newcommand*{\ADDR}{\text{Address}}
\newcommand*{\WORD}{\text{Word}}
\newcommand*{\VMID}{\text{VMID}}
\newcommand*{\REGNAMES}{\text{RegisterName}}
\newcommand*{\DONE}{\text{DoneState}}
\newcommand*{\INSTR}{\text{Instruction}}
\newcommand*{\LOC}{\text{Loc}}
\newcommand*{\VAL}{\text{Val}}
\newcommand*{\GREGS}{\text{GenRegs}}
\newcommand*{\VM}{\text{VM}}
\newcommand*{\PABITS}{\text{ADDR\_BITS}}
\newcommand*{\PPBITS}{\text{PAGE\_BITS}}
\newcommand*{\PPIDBITS}{\text{PID\_BITS}}
\newcommand*{\PAMAX}{\text{ADDR\_MAX}}
\newcommand*{\PPMAX}{\text{PAGE\_MAX}}
\newcommand*{\PPIDMAX}{\text{PID\_MAX}}
\newcommand*{\PWBITS}{\text{WORD\_BITS}}
\newcommand*{\PWMAX}{\text{WORD\_MAX}}
\newcommand*{\PVMMAX}{\text{VM\_MAX}}
\newcommand*{\instrm}[1]{\mathtt{#1}}
\newcommand*{\instr}[1]{\texttt{#1}}
\newcommand*{\EI}[1]{\mathtt{ExecInstr} \; {#1}}
\newcommand*{\RP}[1]{\mathtt{Repeat} \; {#1}}
\newcommand*{\DN}[1]{\mathtt{Done} \; {#1}}
\newcommand*{\NXT}[1]{\mathtt{Next} \; {#1}}
\newcommand{\SOME}{\mathtt{Some}}
\newcommand{\NONE}{\mathtt{None}}
\newcommand{\False}{\text{False}}
\newcommand{\T}{\text{T}}
\newcommand{\R}{\text{R}}

\begin{document}

\begin{figure}[!htb]
  \begin{align*}
      & \text{Points-to assertions} &\defined &\LOC \mapsText{fin} \VAL &l \mapsto v \\
      & \text{Ownership/access assertions} &\defined &\PID \mapsText{fin} \VMID \mapsText{fin} (\text{OwnershipState} \times \text{AccessState}) & OE(p)_{n} \\
      & \text{VM state assertions} &\defined &\VMID \mapsText{fin} \GREGS \mapsText{fin} \VAL &\VM (n)[\REG{R0}] = v \dots \\
      & \text{VM tokens} &\defined &\VMID &\VMTOK{n} \\
      & \;\;\;\; \OS & \derived & O | !O \\
      & \;\;\;\; \AS & \derived & NA | EA | SA \\
      & \;\;\;\; \GREGS &\derived & \REG{pc} | \REG{R0} | \REG{R1} | \dots \\
  \end{align*}
  
  \begin{align*}
     & \text{Transactions} &\defined \VMID \times \text{list}((\text{Handle} \times \text{TransactionType} \times \text{list}((\VMID, \text{list}(\PID))))) \\ 
     & &\T (n, [(h_1, \text{DONATE}, [(k, [p_1, p_2]), \dots]), (h_2, \text{LEND}, [(m, [p_3, p_4]), \dots]), \dots]) \\
     & \text{Receipts} &\defined \text{list}((\text{Handle} \times \text{list}(\PID))) \\
     & &\R ([(h_1, [p_1, p_2]), \dots])
  \end{align*}
  \caption{Resources}
\end{figure}

\begin{figure}[!hbt]
  \hspace{15cm} Transactions and receipts may be split.
  \begin{align*}
      & l \mapsto v \land \l \mapsto v' \vdash v = v' \\
      & l \mapsto v * \l \mapsto v' \vdash \False \\
      & \VMTOK{n} \land \VMTOK{n'} \vdash n = n' \\
      & \VMTOK{n} * \VMTOK{n'} \vdash \False \\
      & \VM (n) [\REG{reg}] = x \land \VM (n) [\REG{reg}] = x' \vdash x = x' \\
      & \VM (n) [\REG{reg}] = x * \VM (n) [\REG{reg}] = x' \vdash \False \\
      & XY (p)_{n} \land X'Y' (p)_{n} \vdash X = X' \land Y = Y' \\
      & XY (p)_{n} * X'Y' (p)_{n} \vdash \False
  \end{align*}
  \caption{Resource properties}
\end{figure}

\begin{figure}[H]
\begin{prooftree}
\AxiomC{\textbf{validVMID(z)}}
\AxiomC{\textbf{decodeFFA(y) = RUN}}
\AxiomC{\textbf{decodeInstr(instr) = hvc}}
\TrinaryInfC{$\hoareV{\later \VM(0)[\REG{PC}] = x * \later ((-(E|S))(\text{pid}(x)))_0 
                    * \later x \mapsto instr * \later \VM(0)[\REG{R0}] = y 
                    * \later \VM(0)[\REG{R1}] = z * \later \VMTOK{0}}
					{\textsf{ExecInstr 0}}
					{v, v = \textsf{Done Next z} * \VM(0)[\REG{PC}] = x + 1 
					* ((-(E|S))(\text{pid}(x)))_0 * x \mapsto instr 
					* \VM(0)[\REG{R0}] = y * \VM(0)[\REG{R1}] = z 
					* \VMTOK{z}}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{\textbf{validVMID(z)} \ \textbf{decodeFFA(y) = DONATE}}
\AxiomC{\textbf{?validDescriptor?} \ \textbf{?freshHandler(h1)?}}
\AxiomC{\textbf{decodeInstr(instr) = hvc}}
\TrinaryInfC{$\hoareV{\later \VM(0)[\REG{PC}] = x * \later ((-(E|S))(\text{pid}(x)))_0 
                     * \later x \mapsto inst * \later \VM(0)[\REG{R0}] = y 
                     * \later \VMTOK{z} * \later \text{?OE for every page in transaction?}}
					{\textsf{ExecInstr z}}
					{v, v = \textsf{Done Next z} * \VM(0)[\REG{PC}] = x + 1 
					* ((-(E|S))(\text{pid}(x)))_0 * x \mapsto instr 
					* \VM(0)[\REG{R0}] = y
					* \VMTOK{z} * \text{?!ON for every page in transaction?} 
					* \T (z, [(h1, \text{DONATE}, \text{list of receivers with pages})])
					* \R (h1, [])}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{\textbf{validVMID(z)} \ \textbf{decodeFFA(y) = RECEIVE}}
\AxiomC{\textbf{?validDescriptor?}}
\AxiomC{\textbf{decodeInstr(instr) = hvc}}
\TrinaryInfC{$\hoareV{\later \VM(0)[\REG{PC}] = x * \later ((-(E|S))(\text{pid}(x)))_0 
                     * \later x \mapsto inst * \later \VM(0)[\REG{R0}] = y 
                     * \later \VMTOK{z} * \later \T (n, [(h1, \text{DONATE}, [z, \text{list of pages}])])}
					{\textsf{ExecInstr z}}
					{v, v = \textsf{Done Next z} * \VM(0)[\REG{PC}] = x + 1 
					* ((-(E|S))(\text{pid}(x)))_0 * x \mapsto instr 
					* \VM(0)[\REG{R0}] = y
					* \VMTOK{z} * \text{?OE for every page in transaction?} 
					* \R (h1, \text{list of pages})}$}
\end{prooftree}
\end{figure}

\begin{figure}[hbt!]
\begin{prooftree}
\AxiomC{$\hoareV{P}{\textsf{ExecInstr i}}{Q}$}
\UnaryInfC{$\hoareV{P}{\textsf{Repeat Done Next i}}{Q}$}
\end{prooftree}

\begin{prooftree}
\AxiomC{$\hoareV{P}{e}{Q}$}
\AxiomC{$\forall v. \hoareV{Q}{\textsf{Repeat v}}{R}$}
\BinaryInfC{$\hoareV{P}{\textsf{Repeat e}}{R}$}
\end{prooftree}
\end{figure}

\end{document}